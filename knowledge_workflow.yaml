# Repository Knowledge Agent Workflow
variables:
  models:
    advanced_model: &advanced_model anthropic/claude-3.7-sonnet
    efficiency_model: &efficiency_model anthropic/claude-3.5-haiku
    knowledge_model: &knowledge_model google/gemini-2.0-flash-lite-001
  mode: ACT

agents:
  - id: title_generation_worker
    model: *efficiency_model
    tool_supported: true
    tools:
      - tool_forge_event_dispatch
    subscribe:
      - user_task_init
    system_prompt: "{{> system-prompt-title-generator.hbs }}"
    user_prompt: <technical_content>{{event.value}}</technical_content>

  - id: repo_knowledge_agent
    model: *knowledge_model
    tool_supported: true
    tools:
      - tool_forge_event_dispatch
    subscribe:
      - repo_knowledge_query
    system_prompt: "{{> system-prompt-repo-knowledge-agent.hbs }}"
    user_prompt: <query>{{event.value}}</query>

  - id: help_agent
    model: *knowledge_model
    tools:
      - tool_forge_fs_read
      - tool_forge_fs_create
    subscribe:
      - user_help_query
    system_prompt: |
      {{> system-prompt-help.hbs }}
    user_prompt: <query>{{event.value}}</query>

  - id: software-engineer
    model: *advanced_model
    tool_supported: true
    tools:
      - tool_forge_fs_read
      - tool_forge_fs_create
      - tool_forge_fs_remove
      - tool_forge_fs_patch
      - tool_forge_process_shell
      - tool_forge_net_fetch
      - tool_forge_fs_search
      - tool_forge_event_dispatch
    subscribe:
      - user_task_init
      - user_task_update
      - repo_knowledge_response
    ephemeral: false
    max_walker_depth: 4
    system_prompt: |
      {{> system-prompt-engineer.hbs }}
      You have access to a Repository Knowledge Agent that knows the entire codebase.
      First, ALWAYS consult the repo_knowledge_agent before doing any analysis:
      After receiving the response, begin your preliminary analysis inside `<analysis>` tags:
      1. To ask a question, dispatch a 'repo_knowledge_query' event with your question
      2. The knowledge agent will receive your query through its subscription to that event
      3. After analyzing the repository content, the knowledge agent will dispatch a 'repo_knowledge_response' event
      4. You will receive this response as a separate message from the system
      
      CRITICAL INSTRUCTION: 
      - NEVER try to understand the codebase through direct file analysis
      - ALWAYS send questions to the repo_knowledge_agent BEFORE making ANY decisions  
      - WAIT for responses from repo_knowledge_agent before proceeding with your task
      - RELY ONLY on the information provided by repo_knowledge_agent about the codebase
      - For EVERY new aspect of the codebase you need to understand, SEND A NEW QUERY
      
      Example workflow:
      
      1. Send query:
      ```xml
      <tool_call>
      <tool_forge_event_dispatch>
      <event>repo_knowledge_query</event>
      <value>How does the error handling work in the forge_domain crate?</value>
      </tool_forge_event_dispatch>
      </tool_call>
      ```
      
      2. The knowledge agent will process your query and respond separately.
    user_prompt: |
      <task>{{event.value}}</task>
      <mode>{{variables.mode}}</mode>
