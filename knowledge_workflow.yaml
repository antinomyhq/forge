# Repository Knowledge Agent Workflow
variables:
  models:
    advanced_model: &advanced_model anthropic/claude-3.7-sonnet
    efficiency_model: &efficiency_model anthropic/claude-3.5-haiku
    knowledge_model: &knowledge_model google/gemini-2.0-flash-thinking-exp:free
  mode: ACT

agents:
  - id: title_generation_worker
    model: *efficiency_model
    tool_supported: true
    tools:
      - tool_forge_event_dispatch
    subscribe:
      - user_task_init
    system_prompt: "{{> system-prompt-title-generator.hbs }}"
    user_prompt: <technical_content>{{event.value}}</technical_content>

  - id: repo_knowledge_agent
    model: *knowledge_model
    tool_supported: true
    tools:
      - tool_forge_event_dispatch
    subscribe:
      - repo_knowledge_query
    system_prompt: "{{> system-prompt-repo-knowledge-agent.hbs }}"
    user_prompt: <query>{{event.value}}</query>

  - id: help_agent
    model: *knowledge_model
    tools:
      - tool_forge_fs_read
      - tool_forge_fs_create
    subscribe:
      - user_help_query
    system_prompt: |
      {{> system-prompt-help.hbs }}
    user_prompt: <query>{{event.value}}</query>

  - id: software-engineer
    model: *advanced_model
    tool_supported: true
    tools:
      - tool_forge_fs_read
      - tool_forge_fs_create
      - tool_forge_fs_remove
      - tool_forge_fs_patch
      - tool_forge_process_shell
      - tool_forge_net_fetch
      - tool_forge_fs_search
      - tool_forge_event_dispatch
    subscribe:
      - user_task_init
      - user_task_update
      - repo_knowledge_response
    ephemeral: false
    max_walker_depth: 4
    system_prompt: |
      {{> system-prompt-engineer.hbs }}
      ## Repository Knowledge Agent Integration

      You have access to a Repository Knowledge Agent that knows the entire codebase.

      ### Knowledge Agent Workflow

      Before performing any analysis or making any decisions about the codebase:

      1. **Always** consult the repo_knowledge_agent by sending a clear, specific question
      2. To ask a question, dispatch a 'repo_knowledge_query' event with your question
      3. The knowledge agent will receive your query through its subscription to that event
      4. After analyzing the repository content, the knowledge agent will dispatch a 'repo_knowledge_response' event
      5. You will receive this response as a separate message from the system
      6. Wait for the knowledge agent's response before proceeding with your analysis
      7. If the response is incomplete or raises new questions, send additional queries

      ### CRITICAL RULES

      - **NEVER** try to understand the codebase through direct file analysis
      - **ALWAYS** send questions to the repo_knowledge_agent BEFORE making ANY decisions
      - **RELY ONLY** on the information provided by repo_knowledge_agent about the codebase
      - For **EVERY** new aspect of the codebase you need to understand, SEND A NEW QUERY
      - **DO NOT** end your response or proceed with your task until you've received complete information from the knowledge agent
      
    user_prompt: |
      <task>{{event.value}}</task>
      <mode>{{variables.mode}}</mode>
