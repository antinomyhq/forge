# -------------------------------------------------------------------
# ------------------------------- WARNING ---------------------------
# -------------------------------------------------------------------
#
# This file was automatically generated by gh-workflows using the
# gh-workflow-gen bin. You should add and commit this file to your
# git repository. **DO NOT EDIT THIS FILE BY HAND!** Any manual changes
# will be lost if the file is regenerated.
#
# To make modifications, update your `build.rs` configuration to adjust
# the workflow description as needed, then regenerate this file to apply
# those changes.
#
# -------------------------------------------------------------------
# ----------------------------- END WARNING -------------------------
# -------------------------------------------------------------------

name: PR Binary Build
on:
  pull_request: {}
jobs:
  build_pr_binaries:
    name: build-pr-binaries
    runs-on: ${{ matrix.os }}
    permissions:
      actions: read
      contents: read
    strategy:
      matrix:
        include:
        - binary_name: forge-x86_64-unknown-linux-musl
          binary_path: target/x86_64-unknown-linux-musl/debug/forge
          cross: 'false'
          os: ubuntu-latest
          target: x86_64-unknown-linux-musl
      fail-fast: false
    steps:
    - uses: actions/checkout@v4
    - uses: taiki-e/setup-cross-toolchain-action@v1
      with:
        target: ${{ matrix.target }}
    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}
    - if: '!contains(matrix.target, ''-unknown-linux-gnu'')'
      run: echo "RUSTFLAGS=-C target-feature=+crt-static" >> $GITHUB_ENV
    - if: contains(matrix.target, 'aarch64-unknown-linux-gnu')
      run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
    - name: Build binary
      uses: ClementTsang/cargo-action@v0.0.6
      with:
        command: build
        args: --target ${{ matrix.target }}
        use-cross: ${{ matrix.cross }}
        cross-version: 0.2.4
      env:
        RUSTFLAGS: ${{ env.RUSTFLAGS }}
        APP_VERSION: pr-${{ github.event.pull_request.number }}-${{ github.sha }}
    - name: Rename binary
      run: cp '${{ matrix.binary_path }}' '${{ matrix.binary_name }}'
    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.binary_name }}
        path: ${{ matrix.binary_name }}
        retention-days: '7'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
