before_run:
  # Install AI SDK for LLM verification
  - npm install --no-save ai @ai-sdk/google-vertex zod

run:
  # Clone into `tmp/task` dir
  - git clone --depth=1 --branch main https://github.com/antinomyhq/forge .
  - forgee workspace sync
  - FORGE_OVERRIDE_PROVIDER=open_router FORGE_OVERRIDE_MODEL={{model}} FORGE_DEBUG_REQUESTS='{{dir}}/context.json' forgee -p '{{task}}'

parallelism: 30
timeout: 120
early_exit: true

validations:
  - name: "Uses semantic search tool"
    type: shell
    command: cat '{{dir}}/context.json' | jq -e '[.messages[]?.tool_calls[]? | select(.function.name == "sem_search")] | any'

  - name: "LLM Judge: Query Quality"
    type: shell
    command: |
      # Only run LLM judge if sem_search was actually called
      if ! cat '{{dir}}/context.json' | jq -e '[.messages[]?.tool_calls[]? | select(.function.name == "sem_search")] | any' > /dev/null 2>&1; then
        echo "Skipping LLM judge: sem_search tool was not used"
        exit 0
      fi
      
      tsx benchmarks/evals/semantic_search_quality/llm_judge.ts \
        --context '{{dir}}/context.json' \
        --intent '{{intent}}' \
        --expected-file-types '{{expected_file_types}}' \
        --should-avoid '{{should_avoid}}'

sources:
  - value:
      - model: "anthropic/claude-sonnet-4.5"

  - value:
      # Implementation-focused queries - should get code, not docs
      - task: "Find the retry mechanism with exponential backoff implementation"
        intent: "implementation"
        expected_file_types: "rust,typescript,javascript"
        should_avoid: "markdown,txt,documentation"

      - task: "Show me how OAuth token refresh is implemented"
        intent: "implementation"
        expected_file_types: "rust,typescript,javascript"
        should_avoid: "markdown,txt,documentation"

      - task: "Where is the semantic search embedding query processing implemented?"
        intent: "implementation"
        expected_file_types: "rust"
        should_avoid: "markdown,schema,json"

      - task: "Find the service layer error handling implementation"
        intent: "implementation"
        expected_file_types: "rust"
        should_avoid: "markdown,test"

      # Understanding flow queries - should get implementation flow, not tests
      - task: "How does the authentication flow work from request to response?"
        intent: "flow_understanding"
        expected_file_types: "rust,typescript"
        should_avoid: "test,markdown"

      - task: "Explain the tool execution pipeline from registration to execution"
        intent: "flow_understanding"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      - task: "How are streaming responses from LLMs processed?"
        intent: "flow_understanding"
        expected_file_types: "rust,typescript"
        should_avoid: "test,markdown,documentation"

      # Architecture queries - should get structural code, not implementation details
      - task: "What's the architecture of the semantic search system?"
        intent: "architecture"
        expected_file_types: "rust"
        should_avoid: "test"

      - task: "How do different AI provider adapters integrate with the system?"
        intent: "architecture"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      # Testing queries - should get tests, not implementation
      - task: "Show me test examples for semantic search query generation"
        intent: "tests"
        expected_file_types: "rust,typescript"
        should_avoid: "markdown,documentation"

      - task: "Find test fixtures for user authentication"
        intent: "tests"
        expected_file_types: "rust"
        should_avoid: "markdown,documentation"

      # Documentation queries - should get docs/README, not code
      - task: "Find documentation on how to configure semantic search"
        intent: "documentation"
        expected_file_types: "markdown,txt"
        should_avoid: "rust,typescript,javascript"

      - task: "Where is the API documentation for tools?"
        intent: "documentation"
        expected_file_types: "markdown"
        should_avoid: "rust,typescript,test"

      # Bug investigation queries - should get relevant implementation
      - task: "Why might semantic search return irrelevant results?"
        intent: "debugging"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      - task: "What could cause the reranker to fail?"
        intent: "debugging"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      # Modification queries - should get implementation to modify
      - task: "I need to add a new parameter to the semantic search query"
        intent: "modification"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      - task: "I need to modify the reranking algorithm to consider file types"
        intent: "modification"
        expected_file_types: "rust"
        should_avoid: "test,markdown,documentation"

      # Config/Schema queries - should get config files
      - task: "Find the configuration schema for semantic search"
        intent: "configuration"
        expected_file_types: "rust,json,yaml,toml"
        should_avoid: "markdown"

      - task: "Where are the tool definitions and schemas defined?"
        intent: "structure"
        expected_file_types: "rust,json"
        should_avoid: "markdown,test"
