before_run:
  # Install AI SDK for LLM verification
  - npm install --no-save ai @ai-sdk/google-vertex zod

run:
  # Clone into `tmp/task` dir
  - git clone --depth=1 --branch main https://github.com/antinomyhq/forge .
  - forgee workspace sync
  - FORGE_OVERRIDE_PROVIDER=open_router FORGE_OVERRIDE_MODEL={{model}} FORGE_DEBUG_REQUESTS='{{dir}}/context.json' forgee -p '{{task}}'

parallelism: 30
timeout: 120
early_exit: true

validations:
  - name: "Uses semantic search tool"
    type: shell
    command: cat '{{dir}}/context.json' | jq -e '[.messages[]?.tool_calls[]? | select(.function.name == "sem_search")] | any'

  - name: "LLM Judge: Query Quality"
    type: shell
    command: |
      # Only run LLM judge if sem_search was actually called
      if ! cat '{{dir}}/context.json' | jq -e '[.messages[]?.tool_calls[]? | select(.function.name == "sem_search")] | any' > /dev/null 2>&1; then
        echo "Skipping LLM judge: sem_search tool was not used"
        exit 0
      fi
      
      tsx benchmarks/evals/semantic_search_quality/llm_judge.ts \
        --context '{{dir}}/context.json' \
        --intent '{{intent}}' \
        --expected-file-types '{{expected_file_types}}' \
        --should-avoid '{{should_avoid}}'

sources:
  - value:
      - model: "anthropic/claude-sonnet-4.5"

  - value:
      # Implementation-focused queries - complex but naturally phrased
      - task: "How does workspace sync detect which files need re-embedding?"
        intent: "implementation"
        expected_file_types: "rust"
        should_avoid: "markdown,txt,documentation"

      - task: "Show me the conversation compaction threshold logic"
        intent: "implementation"
        expected_file_types: "rust"
        should_avoid: "markdown,txt,documentation,test"

      - task: "Where does the cross-encoder reranker model get loaded and cached?"
        intent: "implementation"
        expected_file_types: "rust"
        should_avoid: "markdown,schema,json"

      - task: "How are file backups created for undo?"
        intent: "implementation"
        expected_file_types: "rust"
        should_avoid: "markdown,test"

      # Understanding flow queries - trace through system
      - task: "Trace a semantic search query from input to final results"
        intent: "flow_understanding"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      - task: "How does file patching handle validation and atomic writes?"
        intent: "flow_understanding"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      - task: "Explain context window management when tool results overflow"
        intent: "flow_understanding"
        expected_file_types: "rust"
        should_avoid: "test,markdown,documentation"

      # Architecture queries - design understanding
      - task: "How are embeddings separated from vector storage?"
        intent: "architecture"
        expected_file_types: "rust"
        should_avoid: "test"

      - task: "How does tool registration work across MCP and builtin tools?"
        intent: "architecture"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      # Testing queries - specific test scenarios
      - task: "Find tests for semantic search with multiple query embeddings"
        intent: "tests"
        expected_file_types: "rust"
        should_avoid: "markdown,documentation"

      - task: "Show me tests for file operation rollback scenarios"
        intent: "tests"
        expected_file_types: "rust"
        should_avoid: "markdown,documentation"

      # Documentation queries - configuration docs
      - task: "Find docs on semantic search topK and reranker settings"
        intent: "documentation"
        expected_file_types: "markdown,txt"
        should_avoid: "rust,typescript,javascript"

      - task: "Where are the docs for custom agent creation?"
        intent: "documentation"
        expected_file_types: "markdown"
        should_avoid: "rust,typescript,test"

      # Bug investigation - complex failures
      - task: "What causes stale embeddings after workspace sync?"
        intent: "debugging"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      - task: "Why might reranker scoring be inconsistent across queries?"
        intent: "debugging"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      # Modification queries - targeted changes
      - task: "Where should I add embedding generation batching?"
        intent: "modification"
        expected_file_types: "rust"
        should_avoid: "test,markdown"

      - task: "Show me the reranker scoring logic to add file recency weights"
        intent: "modification"
        expected_file_types: "rust"
        should_avoid: "test,markdown,documentation"

      # Config/Schema queries - configuration discovery
      - task: "Where is all the config schema validation code?"
        intent: "configuration"
        expected_file_types: "rust,json,yaml,toml"
        should_avoid: "markdown"

      - task: "How does system prompt templating combine all the pieces?"
        intent: "structure"
        expected_file_types: "rust,markdown"
        should_avoid: "test"
