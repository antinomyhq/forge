# Create a Specialized Plan File Creation Tool

## Objective
Create a specialized file creation tool that only allows writing Markdown files to the plans directory. The tool should generate filenames with a timestamp prefix, a user-provided name, and a version suffix, automatically incrementing the version if a file with the same base name already exists.

## Implementation Plan

### 1. Create the Tool Structure
Priority: High
Complexity: Low
Dependencies: None

Create a new module in `crates/forge_services/src/tools/fs/plan_write.rs` for the plan file creation tool. This will implement the specialized file writing functionality with all the required constraints.

### 2. Define the Input Structure
Priority: High
Complexity: Low
Dependencies: Step 1

Define the input structure for the tool that includes:
- `name`: The base name for the plan file (required)
- `content`: The markdown content to write to the file (required)

The tool will automatically handle date prefixing and version incrementing.

### 3. Implement the Filename Generation Logic
Priority: High
Complexity: Medium
Dependencies: Step 2

Create functionality to:
- Generate filenames with the format `YYYY-MM-DD-{name}-v{version}.md`
- Use the current date for the date prefix
- Start with version 1 and increment if a file with the same date and name exists
- Properly handle and sanitize the name parameter to create valid filenames

### 4. Implement File Path Validation
Priority: High
Complexity: Low
Dependencies: Step 3

Add validation logic to:
- Ensure the file is only created within the plans directory
- Verify that the file has a `.md` extension
- Prevent modification of existing files (this tool is for creation only)

### 5. Implement the ExecutableTool Trait
Priority: High
Complexity: Medium
Dependencies: Step 4

Implement the `ExecutableTool` trait for the new tool to:
- Process the input parameters
- Generate the appropriate filename
- Create the plan file in the correct location
- Return appropriate success or error messages

### 6. Register the Tool in the Registry
Priority: Medium
Complexity: Low
Dependencies: Step 5

Add the new tool to the tool registry in `crates/forge_services/src/tools/registry.rs` so it can be discovered and used by the system.

### 7. Add Unit Tests
Priority: Medium
Complexity: Medium
Dependencies: Step 6

Create comprehensive unit tests to verify:
- Proper filename generation
- Version incrementing works correctly
- Path validation is enforced
- Files are created with the correct content
- Error cases are handled properly

### 8. Update Documentation
Priority: Low
Complexity: Low
Dependencies: Step 7

Update documentation to include information about the new tool and its usage.

## Verification Criteria
- The tool successfully creates plan files with the correct naming convention
- Files can only be created in the plans directory
- Only markdown files can be created
- Version numbers are automatically incremented to avoid conflicts
- Proper error messages are shown for invalid inputs
- All tests pass

## Potential Risks and Mitigations
- Risk: Concurrent usage could result in race conditions when determining next version number
  Mitigation: Use file system operations that are atomic and handle potential conflicts

- Risk: File path manipulation could allow writing outside the plans directory
  Mitigation: Implement strict path validation that normalizes paths and checks for directory traversal attempts

- Risk: Non-markdown files could be created by adding `.md` extension to another file type
  Mitigation: Add basic markdown validation to ensure content appears to be markdown

## Alternative Approaches
1. **Use UUID or timestamp-based unique identifiers**: Instead of version numbers, generate completely unique identifiers for each file. However, this would make file names less readable and user-friendly.

2. **Extend the existing fs_write tool with a mode parameter**: Modify the existing file write tool to have a "plan mode" with these constraints. This would be more complex and potentially impact the existing tool.

3. **Create a higher-level workflow command**: Rather than implement as a tool, create a workflow command that orchestrates the existing fs_write tool with the additional constraints. This would be less integrated but easier to implement.