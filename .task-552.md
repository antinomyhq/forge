# Task Plan for Issue #552: Refactor `println!` calls to use Infrastructure Trait

## Issue Details

**Title:** refactor: Migrate all the `println`

**Description:**
- We have plenty of tools that have `println` inside them.
- We need to refactor that out and expose that API via the Infrastructure trait.
- All tools should use infra to print text on the console, instead of printing using `println!`
- The infra implementation should use println.
- The design inspiration should come from all the file operations that we perform currently via the infrastructure layer.

## Plan

This refactoring will introduce a new console output service in the infrastructure layer, removing direct dependencies on `println!` from the codebase. This will improve testability, maintainability, and provide a consistent approach to console output.

### Key Design Decisions

1. Create a new `ConsoleService` trait in `forge_app/src/lib.rs` 
2. Add associated type to the `Infrastructure` trait for the console service
3. Implement the console service in `forge_infra/src`
4. Refactor all tools to use the infrastructure's console service instead of direct `println!` calls
5. Ensure proper error handling is integrated with the new console service

### Requirements

1. ✅ All direct `println!` calls should be removed from tools and replaced with the infrastructure console service
2. ✅ The infrastructure implementation should internally use `println!`
3. ✅ The design should follow the pattern established for other infrastructure services
4. ✅ Implementation should maintain the current functionality (output formatting, etc.)
5. ✅ Integration tests should be updated to support the new abstraction
6. ✅ Maintain backward compatibility where possible
7. ✅ Documentation for the new service should be added

## Implementation Steps

### 1. Define the Console Service Trait

- [ ] Create `ConsoleService` trait in `forge_app/src/lib.rs`
- [ ] Define methods for different types of console output (standard output, error output)
- [ ] Include formatting capabilities similar to `println!` macro
- [ ] Add support for colored output

### 2. Update Infrastructure Trait

- [ ] Add associated type `ConsoleService` to the `Infrastructure` trait
- [ ] Add method `console_service(&self) -> &Self::ConsoleService` to the trait
- [ ] Update all implementations of `Infrastructure` to include the new service

### 3. Implement Console Service

- [ ] Create `console.rs` in `forge_infra/src/`
- [ ] Implement `ForgeConsoleService` struct
- [ ] Implement the `ConsoleService` trait for this struct
- [ ] Add the implementation to `ForgeInfra` struct

### 4. Refactor Direct `println!` Usage

- [ ] Identify and refactor all `println!` calls in the codebase
- [ ] Update imports in affected files
- [ ] Ensure formatting and output behavior remains consistent
- [ ] Pay special attention to tools that format output (like diff tools)

### 5. Test Infrastructure

- [ ] Create unit tests for the console service
- [ ] Update existing tests that rely on console output
- [ ] Create mock implementation for testing

### 6. Documentation

- [ ] Document the new console service
- [ ] Update relevant documentation to reflect the new pattern for console output
- [ ] Add examples of usage

## File Changes Required

1. **New Files**:
   - `forge_infra/src/console.rs` - Implementation of the console service

2. **Modified Files**:
   - `forge_app/src/lib.rs` - Add console service trait
   - `forge_infra/src/infra.rs` - Update infrastructure implementation
   - `forge_infra/src/lib.rs` - Export console service
   - Multiple tool files that use `println!` directly

## Verification Criteria

- [ ] All direct `println!` calls should be removed from tools
- [ ] Console output should remain functionally identical
- [ ] All tests should pass
- [ ] Code review should confirm that the implementation follows the established pattern
- [ ] Manual verification of tools that heavily use console output (diff, shell, etc.)

## Implementation Notes

### Console Service Trait Design (Draft)

```rust
/// Service for outputting text to the console
#[async_trait::async_trait]
pub trait ConsoleService: Send + Sync {
    /// Print a message to the console standard output
    fn stdout(&self, message: &str);
    
    /// Print a formatted message to the console standard output
    fn stdout_fmt(&self, format: fmt::Arguments<'_>);
    
    /// Print a message to the console error output
    fn stderr(&self, message: &str);
    
    /// Print a formatted message to the console error output
    fn stderr_fmt(&self, format: fmt::Arguments<'_>);
}
```

### ForgeConsoleService Implementation (Draft)

```rust
pub struct ForgeConsoleService;

impl ForgeConsoleService {
    pub fn new() -> Self {
        Self
    }
}

#[async_trait::async_trait]
impl ConsoleService for ForgeConsoleService {
    fn stdout(&self, message: &str) {
        println!("{}", message);
    }
    
    fn stdout_fmt(&self, format: fmt::Arguments<'_>) {
        println!("{}", format);
    }
    
    fn stderr(&self, message: &str) {
        eprintln!("{}", message);
    }
    
    fn stderr_fmt(&self, format: fmt::Arguments<'_>) {
        eprintln!("{}", format);
    }
}
```

### Macro Helper (Considerations)

It might be useful to create a helper macro to simplify the migration from `println!` to the console service. This could make the code more readable and easier to maintain:

```rust
macro_rules! console_println {
    ($infra:expr, $($arg:tt)*) => {
        $infra.console_service().stdout_fmt(format_args!($($arg)*))
    }
}
```

This would allow for a more natural transition from `println!` to the infrastructure pattern.