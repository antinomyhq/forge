# Task Plan for Issue #541

## Issue Details
**Title:** Bug: Agent not responding to subsequent prompts after error  
**Description:**  
When invoking a tool call with tool_forge_fs_create, the agent fails with an error message related to parsing tool call arguments. After encountering this error, the agent does not respond to subsequent prompts.

Error details:
```bash
âœ— error Failed to parse tool call: [ToolCallPart { call_id: Some(ToolCallId("toolu_vrtx_01VibciqALXHDEjsKRfWXTRt")), name: Some(ToolName("tool_forge_fs_create")), arguments_part: "" }, ToolCallPart { call_id: None, name: None, arguments_part: "" }, ToolCallPart { call_id: None, name: None, arguments_part: "{\"path\": \"" }, ToolCallPart { call_id: None, name: None, arguments_part: "/Users/ami" }, ToolCallPart { call_id: None, name: None, arguments_part: "t/code-forg" }, ToolCallPart { call_id: None, name: None, arguments_part: "e/crates" }, ToolCallPart { call_id: None, name: None, arguments_part: "/forg" }, ToolCallPart { call_id: None, name: None, arguments_part: "e_ci/test" }, ToolCallPart { call_id: None, name: None, arguments_part: "s/c" }, ToolCallPart { call_id: None, name: None, arguments_part: "i.rs\"" }]

Caused by:
    Invalid tool call arguments: EOF while parsing an object at line 1 column 61
```

**Forge version:** 0.47.2

## Problem Analysis

Based on the error message, we can identify several key issues:

1. The tool call parameters for `tool_forge_fs_create` are being split into multiple `ToolCallPart` fragments, causing parsing failures.
2. The error shows a JSON parsing failure: "EOF while parsing an object at line 1 column 61" 
3. After this error occurs, the agent stops responding to subsequent prompts altogether.

The issue appears to be two-fold:
- The agent doesn't properly handle fragmented tool call arguments - specifically when a JSON string is split across multiple ToolCallPart objects
- The agent doesn't recover gracefully from tool call parsing errors, causing it to stop responding

## Plan

### 1. Investigation Steps
1. Review the tool call parser implementation in `forge_domain/src/tool_call_parser.rs`
2. Analyze how tool call parts are merged in `forge_domain/src/tool_call.rs`, specifically in the `try_from_parts` method
3. Examine error handling in the conversation flow by reviewing:
   - `forge_domain/src/conversation.rs`
   - `forge_app/src/conversation.rs`
   - `forge_api/src/api.rs`
4. Identify where the agent gets "stuck" after encountering parsing errors

### 2. Proposed Changes
1. **Improve Tool Call Argument Parsing:**
   - Enhance the `try_from_parts` method in `forge_domain/src/tool_call.rs` to properly handle fragmented JSON arguments
   - Add logic to concatenate argument fragments before attempting to parse as JSON
   - Add validation to ensure complete JSON objects are properly reconstructed

2. **Implement Error Recovery:**
   - Modify error handling in `forge_app/src/conversation.rs` to prevent the agent from getting stuck
   - Add recovery mechanisms in the conversation flow to handle parsing errors gracefully
   - Ensure the agent remains responsive even when tool call parsing fails

3. **Add Diagnostic Logging:**
   - Add detailed logging in `forge_domain/src/tool_call.rs` to trace tool call parsing process
   - Include intermediate state information in logs to aid in debugging tool call errors
   - Log fragmented ToolCallParts to help diagnose similar issues in the future

## Implementation Steps Checklist

- [ ] **Investigation Phase**
  - [ ] Review `forge_domain/src/tool_call_parser.rs` to understand current parsing logic
  - [ ] Analyze `forge_domain/src/tool_call.rs` and the `try_from_parts` method
  - [ ] Examine conversation flow in relevant files to identify error handling gaps
  - [ ] Create a test case that reproduces the error with fragmented tool call arguments

- [ ] **Fix Tool Call Argument Parsing**
  - [ ] Modify `try_from_parts` method in `forge_domain/src/tool_call.rs` to concatenate argument fragments
  - [ ] Add logic to collect all JSON fragments before attempting to parse
  - [ ] Add validation to ensure complete JSON objects before parsing
  - [ ] Add unit tests for fragmented JSON arguments

- [ ] **Implement Error Recovery**
  - [ ] Modify error handling in conversation flow to prevent agent from getting stuck
  - [ ] Implement robust error recovery in the agent conversation cycle
  - [ ] Ensure agent continues to respond after tool call parsing errors
  - [ ] Add tests to verify agent responsiveness after errors

- [ ] **Add Diagnostic Logging**
  - [ ] Add detailed logs for tool call parsing process
  - [ ] Include intermediate state information in logs
  - [ ] Log reconstructed JSON before parsing attempts

- [ ] **Testing**
  - [ ] Create integration tests for the entire fix
  - [ ] Test with various fragmented JSON patterns
  - [ ] Test with special characters and paths with spaces
  - [ ] Verify agent responsiveness after errors
  - [ ] Ensure all existing tests still pass

## Files to Modify

1. **Primary Files:**
   - `crates/forge_domain/src/tool_call.rs` - The main file to modify to fix JSON concatenation
   - `crates/forge_domain/src/tool_call_parser.rs` - May need adjustments to support fragmented parsing
   - `crates/forge_app/src/conversation.rs` - Needs changes for error recovery

2. **Secondary Files:**
   - `crates/forge_domain/src/error.rs` - Might need new error types
   - `crates/forge_api/src/api.rs` - May need changes in error handling
   - Relevant test files to add new test cases

## Requirements

1. The agent must properly handle fragmented tool call arguments, especially when they contain file paths
2. The agent must recover gracefully from tool call parsing errors
3. The agent must continue to respond to user prompts even after encountering errors
4. The solution should maintain backward compatibility with existing code
5. Appropriate logging should be added to help diagnose similar issues

## Verification Criteria

1. **JSON Reconstruction Test:**
   - Create a test with fragmented JSON path strings
   - Verify the parser correctly reconstructs them 
   - Test with paths containing special characters and spaces

2. **Error Recovery Test:**
   - Introduce deliberate parsing errors in tests
   - Verify the agent recovers and continues responding
   - Confirm error messages are clear but don't break agent functionality

3. **Integration Tests:**
   - Test the full conversation flow with error conditions
   - Verify agent remains responsive after errors
   - Ensure no regressions in existing functionality

4. **Manual Testing:**
   - Test with real tool calls containing complex paths
   - Verify agent recovery from parsing errors in a real session
   - Confirm appropriate error logs are generated