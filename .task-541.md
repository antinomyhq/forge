# Task Plan for Issue #541

## Issue Details
**Title:** Bug: Agent not responding to subsequent prompts after error  
**Description:**  
When invoking a tool call with tool_forge_fs_create, the agent fails with an error message related to parsing tool call arguments. After encountering this error, the agent does not respond to subsequent prompts.

Error details:
```bash
âœ— error Failed to parse tool call: [ToolCallPart { call_id: Some(ToolCallId("toolu_vrtx_01VibciqALXHDEjsKRfWXTRt")), name: Some(ToolName("tool_forge_fs_create")), arguments_part: "" }, ToolCallPart { call_id: None, name: None, arguments_part: "" }, ToolCallPart { call_id: None, name: None, arguments_part: "{\"path\": \"" }, ToolCallPart { call_id: None, name: None, arguments_part: "/Users/ami" }, ToolCallPart { call_id: None, name: None, arguments_part: "t/code-forg" }, ToolCallPart { call_id: None, name: None, arguments_part: "e/crates" }, ToolCallPart { call_id: None, name: None, arguments_part: "/forg" }, ToolCallPart { call_id: None, name: None, arguments_part: "e_ci/test" }, ToolCallPart { call_id: None, name: None, arguments_part: "s/c" }, ToolCallPart { call_id: None, name: None, arguments_part: "i.rs\"" }]

Caused by:
    Invalid tool call arguments: EOF while parsing an object at line 1 column 61
```

**Forge version:** 0.47.2

## Problem Analysis

Based on the error message, we can identify several key issues:

1. The tool call parameters for `tool_forge_fs_create` are being split into multiple `ToolCallPart` fragments, causing parsing failures.
2. The error shows a JSON parsing failure: "EOF while parsing an object at line 1 column 61" 
3. After this error occurs, the agent stops responding to subsequent prompts altogether.

The issue appears to be two-fold:
- The agent doesn't properly handle fragmented tool call arguments
- The agent doesn't recover gracefully from tool call parsing errors, causing it to stop responding

## Plan

### 1. Investigation Steps
1. Review the tool call parser implementation in `forge_domain/src/tool_call_parser.rs`
2. Understand how tool call parts are currently handled and merged
3. Examine error handling in the agent conversation flow
4. Identify where the agent gets "stuck" after encountering parsing errors

### 2. Proposed Changes
1. **Improve Tool Call Argument Parsing:**
   - Enhance the parser to properly handle fragmented argument JSON
   - Implement better reconstruction of split JSON arguments across multiple ToolCallParts
   - Add validation to ensure complete JSON objects are properly constructed

2. **Implement Error Recovery:**
   - Add a recovery mechanism that allows the agent to continue functioning after parsing errors
   - Ensure the conversation state remains valid even when tool calls fail
   - Implement proper error boundaries to prevent errors from cascading

3. **Add Diagnostic Logging:**
   - Add more detailed logging around tool call parsing failures
   - Include intermediate state information to aid in debugging
   - Log the entire conversation state when recovery mechanisms activate

### 3. Testing Approach
1. Create a test that simulates fragmented tool call arguments
2. Verify the enhanced parser correctly reconstructs the JSON
3. Test error recovery by introducing deliberate parsing errors
4. Confirm the agent continues to respond after encountering errors

## Requirements

1. The agent must properly handle fragmented tool call arguments, especially when they contain file paths
2. The agent must recover gracefully from tool call parsing errors
3. The agent must continue to respond to user prompts even after encountering errors
4. The solution should maintain backward compatibility with existing code
5. Appropriate logging should be added to help diagnose similar issues

## Acceptance Criteria

1. When tool call parameters are fragmented, the parser correctly reconstructs them
2. If a tool call parsing error occurs, a clear error message is displayed but the agent remains responsive
3. Agent can handle tool calls with paths containing special characters or spaces
4. All existing tests continue to pass
5. New tests are added to verify the fixed functionality