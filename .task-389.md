# Task Plan for Issue #389: Support for `/retry`

## Issue Details

**Title**: feat: Support for `/retry`

**Description**:
**Changes Required**
- This should be a first-class feature supported on the `Api`.
  ```rust
  trait Api {
     fn retry(&self, conversation_id: ConversationId) -> anyhow::Result<MpscStream<Result<AgentMessage<ChatResponse>, anyhow::Error>>>;
  }
  ```
- Idea is that we can pull the last user message from the conversation and convert it to a `ChatRequest` and reinitialize the Orchestrator.
- A new command should be added in `forge_main` that allows the developer to write `/retry` and the execution is retried.
- Make sure we use `TitleFormat` to print a message consistent with the other before retrying is started.

**Technical Requirements**
- Ensure all existing tests pass
- Add new tests wherever required

## Plan

This feature involves adding a "/retry" command functionality to Code Forge which allows users to retry their last conversation by simply typing "/retry". The implementation will span across multiple crates:

1. Add a `retry` method to the `Api` trait in `forge_api`
2. Implement logic to extract the last user message from a conversation
3. Add the `/retry` command handling in `forge_main`
4. Add appropriate title formatting for consistency
5. Add tests to verify the functionality

## Requirements

1. User can type "/retry" to retry the last executed conversation
2. The feature should be implemented as part of the `Api` trait
3. The implementation should extract the last user message from the conversation
4. The retry execution should reinitialize the Orchestrator with the extracted message
5. The UI should display a consistent title/message before retrying
6. All existing tests should continue to pass
7. New tests should be added to verify retry functionality

## Implementation Steps

### 1. Update the `Api` trait in forge_api

- [ ] Add the `retry` method to the `Api` trait in `crates/forge_api/src/api.rs`:
  ```rust
  fn retry(&self, conversation_id: ConversationId) -> anyhow::Result<MpscStream<Result<AgentMessage<ChatResponse>, anyhow::Error>>>;
  ```

### 2. Implement the `retry` method in the API implementation

- [ ] Implement the `retry` method in the API implementation (likely in `crates/forge_api/src/forge_default.rs`)
- [ ] Extract the last user message from the conversation
- [ ] Convert the extracted message to a `ChatRequest`
- [ ] Reinitialize the Orchestrator with the converted request

### 3. Add the `/retry` command handling in forge_main

- [ ] Update the command handling logic in `forge_main` (likely in `crates/forge_main/src/cli.rs` or similar)
- [ ] Add parsing for the `/retry` command
- [ ] Connect the command to the `retry` API method
- [ ] Ensure proper error handling for cases where retry is not possible (e.g., no previous conversation)

### 4. Implement proper title formatting

- [ ] Use `TitleFormat` to display a consistent message before retrying
- [ ] Add appropriate messaging when retry is successful or fails

### 5. Add tests

- [ ] Add unit tests for the `retry` method
- [ ] Add integration tests to verify the end-to-end retry functionality
- [ ] Ensure all existing tests continue to pass

## Verification Criteria

1. **Basic Functionality**: Verify that typing `/retry` successfully retries the last conversation
2. **Edge Cases**:
   - Test behavior when there's no previous conversation to retry
   - Test behavior when the conversation history is large
   - Test behavior when the last message is not from the user
3. **UI/UX**: Verify that the title formatting is consistent with other commands
4. **Performance**: Verify that retry operation performs efficiently, even with large conversation histories

## Additional Notes

- Consider adding a confirmation prompt if the retry operation could be expensive or have side effects
- Consider allowing retry with modifications (e.g., `/retry with changes to X`)
- This feature should be backward compatible with existing systems
- Documentation should be updated to include this new command