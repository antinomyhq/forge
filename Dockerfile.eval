# Dockerfile for code-forge evaluations
# Uses cross-compiled binary from host machine
FROM debian:bookworm-slim

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    libgcc-s1 \
    libc6 \
    && rm -rf /var/lib/apt/lists/*

# Copy the cross-compiled binary (templates are embedded via rust-embed)
COPY target/x86_64-unknown-linux-gnu/release/forge /usr/local/bin/forge

# Make it executable
RUN chmod +x /usr/local/bin/forge

# Set working directory
WORKDIR /workspace

# Create entrypoint script that executes TASK_COMMAND env var
RUN echo '#!/bin/sh\nif [ -n "$TASK_COMMAND" ]; then\n  eval "$TASK_COMMAND"\nelse\n  exec "$@"\nfi' > /entrypoint.sh && chmod +x /entrypoint.sh

# Use entrypoint
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/sh"]
